# debcomp

DebComp (**Deb**ian **Comp**oser) &mdash; система развертывания конфигураций для операционных систем на базе Debian.

*In other languages: [English](README.md), [Русский](README.ru.md).*

---

## Оглавление

- [Введение](#введение)
- [Ключевые особенности](#ключевые-особенности)
- [Структура каталога конфигурации](#структура-каталога-конфигурации)
- [Переменные окружения](#переменные-окружения)
- [Конфигурация компонента](#конфигурация-компонента)


## Введение

В большинстве случаев операционные системы можно использовать с незначительными изменениями их начальной конфигурации. Но отдельные узкоспецифичные случаи использования требуют создания сложных конфигураций, подразумевающих установку и настройку большого количества различного программного обеспечения и внесение в конфигурацию системы большого количества изменений. Со временем их количество разрастается и возникает необходимость в их систематизации, а повторное их внесение вручную на вновь установленную копию системы становится слишком трудоёмкой и не выполнимой за разумное время задачей. На первый взгляд проблема решается простым копированием образа раздела системы или её файлов на любые другие компьютеры. Но в любом случае рано или поздно возникнет ситуация, когда придётся повторить с нуля всю выполненную ранее настройку, к примеру, в случае невозможности обновления дистрибутива или необходимости установки системы на компьютер с другой архитектурой процессора. Частичным решением является учёт всех вносимых изменений для полностью идентичного их внесения на другие копии системы в дальнейшем. Но такой ручной подход слишком долгий, трудоёмкий и ненадёжный &mdash; всегда остаётся риск того, что человеческий фактор сыграет свою роль и что-нибудь окажется не учтено, где-нибудь будет допущена опечатка и т. д. Существуют чуть более удачные решения, такие, как автоматизация развёртывания конфигураций с помощью скриптов, систем управления конфигурациями вроде Ansible и т. п. Но они далеко не идеальны, поскольку не всегда позволяют откатывать внесённые изменения, не позволяют их должным образом упорядочить и не способствуют упрощению переноса конфигураций между разными дистрибутивами и их версиями.

Вторая проблема &mdash; это существующая тенденция к созданию множества новых дистрибутивов ОС, чаще всего на базе Ubuntu или Debian, адаптированных под какие-либо узкоспецифичные задачи в ущерб универсальности. Однако гораздо правильнее вместо дистрибутивов создавать и распространять конфигурации для существующих дистрибутивов, поскольку решать конкретные задачи должно программное обеспечение, а операционная система должна обеспечивать работу прикладного программного обеспечения, но не решать его задачи. Такой подход позволил бы пользователю использовать свой любимый дистрибутив, а не мигрировать на другой, непроверенный и часто ограниченный по возможностям. Но без средства развёртывания конфигураций с простым в использовании пользовательским интерфейсом этот подход оказывается неосуществимым на практике.

С целью решения вышеописанных проблем и был создан проект DebComp.


## Ключевые особенности

- Является переносимым скриптом, написанным на POSIX shell, не имеющим зависимостей, за исключением coreutils, который является необходимым пакетом практически во всех дистрибутивах. Благодаря этому развёртывание конфигурации сводится к копированию каталога конфигурации на целевую систему (например, средствами scp) и запуску debcomp без необходимости установки дополнительного ПО;
- Наличие текстового пользовательского интерфейса (TUI);
- Возможность отката изменений конфигурации системы (за исключением состояния пакетов);
- Гибкая и прозрачная архитектура, соответствующая философии UNIX и не перегруженная лишними элементами;
- Совмещение императивного и декларативного подходов, позволяющее гибко взаимодействовать с ОС напрямую из скриптов, иметь чёткое представление обо всех выполняемых действиях и при необходимости тонко их корректировать, вместо того, чтобы использовать готовые модули как «чёрные ящики», полностью возлагая задачу на них в надежде на то, что всё будет выполнено правильно и без ошибок, при том, что ОС предоставляет простые, гибкие и надёжные средства для её конфигурирования без каких-либо излишних промежуточных слоёв.


## Структура каталога конфигурации

Файл или каталог | Описание
--- | ---
`common/` | Базовый компонент, содержащий общую часть конфигурации.
`common/unmanaged-packages` | Файл, содержащий регулярные выражения для имён пакетов, которые должны игнорироваться, кроме тех случаев, когда имя пакета явно указано в списке пакетов. Эти пакеты будут защищены от удаления и изменения маркировки с manual на auto (см. описание `pkglists/`), а его отсутствие в списке `for()` не будет считаться ошибкой. Полезно для пакетов, имена которых могут измениться в любой момент (таких, как linux-image-*, который содержит версию в имени пакета) и пакетов, предоставляющих поддержку оборудования. В большинстве случаев достаточно одного регулярного выражения <code>^linux(-.+)?-(generic&#124;headers&#124;image&#124;modules)(-.+)?$</code>.
`components/` | Каталог, содержащий компоненты конфигурации.
`{common,components/<component>}/files/` | Каталог, содержащий файлы и каталоги, устанавливаемые в систему. Перед установкой права на все каталоги и файлы выставляются в 755 и 644 соответственно, а их владельцы выставляются в root:root. Изменения прав и владельцев должны выполняться из скрипта `preinst` (пример: `chmod 600 "$PREPDIR/etc/hostapd/hostapd.conf"`).
`{common,components/<component>}/pkglists/` | Каталог, содержащий файлы списков устанавливаемых пакетов и их маркировок (manual или auto). Может содержать подкаталоги с любым уровнем вложенности. Списки пакетов генерируются с помощью субкоманды `analyze-deps` (выполните команду `debcomp analyze-deps --help` для получения подробной информации) и содержат только пакеты, находящиеся в рекомендуемых, предлагаемых или выборочных зависимостях (см. https://www.debian.org/doc/debian-policy/ch-relationships.html) и пакеты, помеченные как manual (т. е. нужные сами по себе, а не только для удовлетворения зависимостей других пакетов, см. https://manpages.debian.org/stable/apt/apt-mark.8.en.html). При выборе компонента устанавливаются все пакеты, перечисленные в этих файлах и их жёсткие зависимости (перечисленные в поле Depends), а остальные пакеты удаляются методом purge.
`{common,components/<component>}/pkgs/` | Каталог, содержащий устанавливаемые вместе с компонентом пакеты, в собранном, либо распакованном виде для автоматической сборки. Перед сборкой пакета права на все его каталоги и файлы выставляются в 755 и 644 соответственно, а их владельцы выставляются в root:root. Изменения прав и владельцев должны выполняться из скрипта `pkgs/<package>/DEBIAN/prebuild` (пример: `chmod 600 "$PREPDIR/etc/hostapd/hostapd.conf"`).
`{common,components/<component>}/apt-sources` | Файл, содержащий дополнительные репозитории, добавляемые в `/etc/apt/sources.list`.
`{common,components/<component>}/control` | Файл конфигурации компонента. См. раздел &laquo;[Конфигурация компонента](#конфигурация-компонента)&raquo;.
`{common,components/<component>}/preinst` | Скрипт, выполняющийся перед установкой файлов в систему.
`{common,components/<component>}/postinst` | Скрипт, выполняющийся после установки файлов в систему.
`{common,components/<component>}/prerm` | Скрипт, выполняющийся перед удалением файлов из системы (при откате установленной ранее конфигурации).
`{common,components/<component>}/postrm` | Скрипт, выполняющийся после удаления файлов из системы (при откате установленной ранее конфигурации).
`presets/` | Каталог, содержащий пресеты конфигураций устанавливаемых компонентов.
`config` | Файл, содержащий конфигурацию устанавливаемых компонентов.
`debcomp` | Главный исполняемый файл.


## Переменные окружения

Имя переменной | Доступна в скриптах | Описание
--- | --- | ---
`CONFDIR` | `preinst`, `postinst`, `prerm`, `postrm`, `prebuild` | Абсолютный путь к каталогу конфигурации.
`SCRIPT_NAME` | `preinst`, `postinst`, `prerm`, `postrm`, `prebuild` | Имя текущего вызванного скрипта.
`COMPONENT` | `preinst`, `postinst`, `prerm`, `postrm` | Путь к каталогу компонента относительно каталога `CONFDIR`.
`PACKAGE` | `prebuild` | Путь к каталогу пакета относительно каталога `CONFDIR`.
`PREPDIR` | `preinst`, `prebuild` | Путь к каталогу, содержащему файлы, подготовленные к установке в систему или для сборки пакета.
`TMPDIR` | `preinst`, `postinst`, `prerm`, `postrm`, `prebuild` | Путь ко временному каталогу. Данный каталог очищается автоматически при завершении работы скрипта.
`VARFILE` | `prerm`, `postrm` | Путь к файлу, содержащему значения переменных, сохранённые с помощью субкоманды `setvar` (выполните команду `debcomp setvar --help` для получения подробной информации). Если этот файл не существует, переменная не будет объявлена.
`CONF_<PARAM>` | `preinst`, `postinst`, `prerm`, `postrm` | Значение параметра конфигурации компонента (см. раздел &laquo;[Конфигурация компонента](#конфигурация-компонента)&raquo;). Часть `<PARAM>` является именем параметра конфигурации в верхнем регистре.


## Конфигурация компонента

Ключи, действительные только для компонента "common":

Ключ | Описание
--- | ---
`osrelease` | Если существует, то будут проверены на соответствие указанному значению имя и версия операционной системы, указанные в переменных `ID` и `VERSION_ID` в файле `/etc/os-release`, либо `/usr/lib/os-release`, если первый не существует. Пример: `osrelease=ubuntu 20.04`.

Ключи, действительные для всех компонентов, кроме "common":

Ключ | Описание
--- | ---
<code>depends/&lt;component&gt;&#124;&lt;component&gt;&#124;...</code> | Объявляет один из компонентов (`<component>`), от которых зависит текущий компонент, либо группу компонентов, разделённых символом <code>&#124;</code>. Если указана группа, то для удовлетворения зависимости должен быть установлен хотя бы один из перечисленных компонентов. Ключ не требует указания значения.
`conflicts/<component>` | Объявляет один из компонентов (`<component>`), с которыми конфликтует текущий компонент. Ключ не требует указания значения.
`after/<component>` | Объявляет один из компонентов (`<component>`), которые должны быть установлены до текущего компонента. Ключ не требует указания значения.

Ключи, действительные для всех компонентов:

Ключ | Описание
--- | ---
`arch/<dpkg_arch>` | Если `arch` существует, то будет проверена архитектура операционной системы (результат выполнения команды `dpkg --print-architecture`) на соответствие любой из перечисленных архитектур. Часть `<dpkg_arch>` соответствует одной из допустимых архитектур. Ключ не требует указания значения.
`name[<lang>]` | Отображаемое имя компонента. Необязательная часть `[<lang>]` используется для указания локализованного варианта значения.
`description[<lang>]` | Описание компонента. Необязательная часть `[<lang>]` используется для указания локализованного варианта значения.
`conf/<param>/name[<lang>]` | Имя параметра конфигурации. Необязательная часть `[<lang>]` используется для указания локализованного варианта значения.
`conf/<param>/description[<lang>]` | Описание параметра конфигурации. Необязательная часть `[<lang>]` используется для указания локализованного варианта значения.
`conf/<param>/type` | Тип значения параметра конфигурации. Может принимать следующие значения: `string`, `integer`, `float`, `boolean`, `select`.
`conf/<param>/default` | Значение параметра конфигурации по умолчанию.
`conf/<param>/regexp` | Регулярное выражение, которому должно соответствовать значение параметра конфигурации, в противном случае конфигурация считается некорректной.
`conf/<param>/min` | Если указано, то значение параметра конфигурации не должно быть меньше указанного значения, в противном случае конфигурация считается некорректной. Применимо только к типам `integer` и `float`.
`conf/<param>/max` | Если указано, то значение параметра конфигурации не должно быть больше указанного значения, в противном случае конфигурация считается некорректной. Применимо только к типам `integer` и `float`.
`conf/<param>/options/<value>` | Если типом значения параметра конфигурации является `select`, то объявляет одно из возможных значений (`<value>`) параметра конфигурации. Ключ не требует указания значения.
`conf/<param>/options/<value>/name[<lang>]` | Отображаемое имя значения параметра конфигурации. Необязательная часть `[<lang>]` используется для указания локализованного варианта значения.
`conf/<param>/options/<value>/description[<lang>]` | Описание значения параметра конфигурации. Необязательная часть `[<lang>]` используется для указания локализованного варианта значения.
